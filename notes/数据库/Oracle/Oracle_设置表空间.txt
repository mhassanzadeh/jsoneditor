Content-Type: text/x-zim-wiki
Wiki-Format: zim 0.4
Creation-Date: 2010-06-04T14:48:48.343000

====== Oracle 设置表空间 ======
Created Friday 04 June 2010

表空间自动扩展
alter database datafile 'e:\\sde.dbf' autoextend on  next 1M maxsize 100M

增加表空间文件
alter tablespace sde add datafile 'd:\sde.dbf' size 1000m

alter tablespace sde add datafile 'D:\APP\ADMINISTRATOR\ORADATA\SJZX\sde2.dbf' size 1000m autoextend on next 200M

查询所有表空间的总容量、已经使用、剩余、已经使用的百分比
select a.tablespace_name,a.bytes/1024/1024 "Sum MB",(a.bytes-b.bytes)/1024/1024 "used MB",b.bytes/1024/1024 "free MB",round(((a.bytes-b.bytes)/a.bytes)*100,2) "percent_used"
from
    (select tablespace_name,sum(bytes) bytes from dba_data_files group by tablespace_name) a,
    (select tablespace_name,sum(bytes) bytes,max(bytes) largest from dba_free_space group by tablespace_name) b
where a.tablespace_name=b.tablespace_name
order by ((a.bytes-b.bytes)/a.bytes) desc

查询表空间包括的所有数据文件
select file_name, tablespace_name from dba_data_files where tablespace_name = 'SDE'

收缩空闲表空间数据文件
select /*+ ordered use_hash(a,c) */
     'alter database datafile '''||a.file_name||''' resize '||round(a.filesize - (a.filesize - c.hwmsize-100) *0.8)||'M;',
    a.filesize,
    c.hwmsize
from
    (select file_id,file_name,round(bytes/1024/1024) filesize from dba_data_files) a,
    (select file_id,round(max(block_id)*8/1024) HWMsize from dba_extents group by file_id) c
where a.file_id = c.file_id and a.filesize - c.hwmsize > 100

查看数据文件使用情况
select /*+ ordered use_hash(a,b,c) */
    a.file_id,a.file_name,a.filesize, b.freesize,
    (a.filesize-b.freesize) usedsize,
    c.hwmsize,
    c.hwmsize - (a.filesize-b.freesize) unsedsize_belowhwm,
    a.filesize - c.hwmsize canshrinksize
from
    (select file_id,file_name,round(bytes/1024/1024) filesize from dba_data_files) a,
    (select file_id,round(sum(dfs.bytes)/1024/1024) freesize from dba_free_space dfs group by file_id) b,
    (select file_id,round(max(block_id)*8/1024) HWMsize from dba_extents group by file_id) c
where a.file_id = b.file_id and a.file_id = c.file_id
order by unsedsize_belowhwm desc
